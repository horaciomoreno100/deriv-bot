// Gateway Database Schema
// Stores market data overflow from memory cache

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL_GATEWAY")
}

// Candles (OHLC data)
model Candle {
  id        Int      @id @default(autoincrement())
  asset     String
  timeframe Int      // seconds (60, 300, 900, 3600, etc)
  timestamp Int      // Unix timestamp (candle start time)
  open      Float
  high      Float
  low       Float
  close     Float
  volume    Float?
  createdAt DateTime @default(now())

  @@unique([asset, timeframe, timestamp])
  @@index([asset, timeframe])
  @@index([timestamp])
  @@map("candles")
}

// Ticks (raw price data)
model Tick {
  id        Int      @id @default(autoincrement())
  asset     String
  price     Float
  timestamp BigInt   // Milliseconds
  direction Int?     // 1 up, -1 down, 0 neutral
  createdAt DateTime @default(now())

  @@index([asset, timestamp])
  @@map("ticks")
}

// Symbols (cached active symbols)
model Symbol {
  symbol        String   @id
  displayName   String
  market        String
  submarket     String
  isOpen        Boolean
  pipSize       Float
  lastUpdated   DateTime @default(now())

  @@map("symbols")
}

// Trades (binary options & CFD contracts)
model Trade {
  id          String   @id @default(cuid())
  contractId  String   @unique

  // Trade info
  type        String   // CALL or PUT (or MULTUP/MULTDOWN for CFDs)
  tradeMode   String   // "binary" or "cfd"
  asset       String
  timeframe   Int?     // seconds (for binary options)

  // Prices & Money
  entryPrice  Float
  exitPrice   Float?
  stake       Float
  payout      Float?

  // CFD-specific fields
  multiplier  Int?     // CFD multiplier (e.g., 50x, 100x)
  takeProfit  Float?   // TP price level
  stopLoss    Float?   // SL price level
  takeProfitAmount  Float?  // TP in dollars
  stopLossAmount    Float?  // SL in dollars

  // Result
  result      String?  // WIN, LOSS, or PENDING
  profit      Float?   // payout - stake (negative if loss)
  profitPct   Float?   // profit percentage

  // Timestamps
  openedAt    DateTime @default(now())
  closedAt    DateTime?
  expiryTime  DateTime?

  // Signal that triggered trade
  signalType  String?  // RSI_OVERSOLD, RSI_OVERBOUGHT, BB_LOWER, BB_UPPER
  confidence  Float?   // Signal confidence (0-1)

  // Indicators at entry
  rsi         Float?
  bbUpper     Float?
  bbMiddle    Float?
  bbLower     Float?
  atr         Float?

  // Additional context
  bbDistancePct Float?  // Distance to BB band (%)
  priceVsMiddle Float?  // Price vs BB middle

  // Market context at entry
  volumeAtEntry Int?
  spreadAtEntry Float?

  // Balance tracking
  balanceBefore Float?
  balanceAfter  Float?

  // Strategy
  strategyName String  // e.g., "mean-reversion-v2"

  // Metadata (JSON string for flexible additional data)
  metadata     String?  // JSON string with extra context

  @@index([openedAt])
  @@index([asset])
  @@index([strategyName])
  @@index([result])
  @@index([tradeMode])
  @@map("trades")
}

// Daily aggregated stats
model DailyStats {
  id        String   @id @default(cuid())
  date      String   @unique // "2025-10-17" - YYYY-MM-DD format

  // Aggregated stats
  totalTrades   Int      @default(0)
  wins          Int      @default(0)
  losses        Int      @default(0)
  pending       Int      @default(0)
  winRate       Float    @default(0)

  // Money
  totalStake    Float    @default(0)
  totalPayout   Float    @default(0)
  netPnL        Float    @default(0)

  // Balance tracking
  startBalance  Float?
  endBalance    Float?

  // Metadata
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([date])
  @@map("daily_stats")
}

// Trading sessions
model Session {
  id           String   @id @default(cuid())
  startedAt    DateTime @default(now())
  endedAt      DateTime?

  // Strategy info
  strategyName String
  asset        String

  // Session stats
  trades       Int      @default(0)
  wins         Int      @default(0)
  losses       Int      @default(0)
  pnl          Float    @default(0)

  // Balance tracking
  startBalance Float
  endBalance   Float?

  @@index([startedAt])
  @@index([strategyName])
  @@map("sessions")
}
