// Root Prisma Schema for BacktestJS
// This is required by @backtest/framework

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// BacktestJS Historical Data Model
model HistoricalData {
  id        String   @id @default(uuid())
  symbol    String
  timestamp BigInt
  open      Float
  high      Float
  low       Float
  close     Float
  volume    Float?
  createdAt DateTime @default(now())

  @@unique([symbol, timestamp])
  @@index([symbol])
  @@map("historical_data")
}

// Candles from Gateway (for compatibility)
model Candle {
  id        Int      @id @default(autoincrement())
  asset     String
  timeframe Int
  timestamp Int
  open      Float
  high      Float
  low       Float
  close     Float
  volume    Float?
  createdAt DateTime @default(now())

  @@unique([asset, timeframe, timestamp])
  @@index([asset, timeframe])
  @@index([timestamp])
  @@map("candles")
}

// Trades (binary options & CFD contracts) - matches gateway schema
model Trade {
  id          String   @id @default(cuid())
  contractId  String   @unique

  // Trade info
  type        String   // CALL or PUT (or MULTUP/MULTDOWN for CFDs)
  tradeMode   String   // "binary" or "cfd"
  asset       String
  timeframe   Int?     // seconds (for binary options)

  // Prices & Money
  entryPrice  Float
  exitPrice   Float?
  stake       Float
  payout      Float?

  // CFD-specific fields
  multiplier  Int?     // CFD multiplier (e.g., 50x, 100x)
  takeProfit  Float?   // TP price level
  stopLoss    Float?   // SL price level
  takeProfitAmount  Float?  // TP in dollars
  stopLossAmount    Float?  // SL in dollars

  // Result
  result      String?  // WIN, LOSS, or PENDING
  profit      Float?   // payout - stake (negative if loss)
  profitPct   Float?   // profit percentage

  // Timestamps
  openedAt    DateTime @default(now())
  closedAt    DateTime?
  expiryTime  DateTime?

  // Signal that triggered trade
  signalType  String?  // RSI_OVERSOLD, RSI_OVERBOUGHT, BB_LOWER, BB_UPPER
  confidence  Float?   // Signal confidence (0-1)

  // Indicators at entry
  rsi         Float?
  bbUpper     Float?
  bbMiddle    Float?
  bbLower     Float?
  atr         Float?

  // Additional context
  bbDistancePct Float?  // Distance to BB band (%)
  priceVsMiddle Float?  // Price vs BB middle

  // Market context at entry
  volumeAtEntry Int?
  spreadAtEntry Float?

  // Balance tracking
  balanceBefore Float?
  balanceAfter  Float?

  // Strategy
  strategyName String  // e.g., "mean-reversion-v2"

  // Metadata (JSON string for flexible additional data)
  metadata     String?  // JSON string with extra context

  @@index([openedAt])
  @@index([asset])
  @@index([strategyName])
  @@index([result])
  @@index([tradeMode])
  @@map("trades")
}

// Daily statistics for Gateway
model DailyStats {
  id           Int      @id @default(autoincrement())
  date         String   @unique // YYYY-MM-DD format
  totalTrades  Int      @default(0)
  wonTrades    Int      @default(0)
  lostTrades   Int      @default(0)
  totalProfit  Float    @default(0)
  totalLoss    Float    @default(0)
  netPnL       Float    @default(0)
  maxDrawdown  Float    @default(0)
  winRate      Float    @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([date])
  @@map("daily_stats")
}
