# Cursor Rules for deriv-bot

## Strategy Runner Script Rules (CRITICAL)

**When creating or modifying strategy runner scripts (`run-*.ts`), you MUST follow these rules to prevent duplicate trades and race conditions.**

### Required Pattern for Signal Processing

Every `processStrategySignal()` function MUST include these checks in this exact order:

```typescript
async function processStrategySignal(signal: Signal | null, asset: string) {
  if (!signal) return;

  // 1. Skip during initialization
  if (isInitializing || !hasReceivedRealtimeCandle) {
    console.log(`\n⏸️  Signal ignored during initialization`);
    return;
  }

  // 2. CRITICAL: Check position limits BEFORE processing
  const canOpen = tradeManager.canOpenTrade(asset);
  if (!canOpen.allowed) {
    console.log(`\n❌ Signal rejected for ${asset}: ${canOpen.reason}`);
    return;
  }

  // 3. CRITICAL: Acquire trade lock to prevent race conditions
  if (!tradeManager.acquireTradeLock(asset)) {
    console.log(`\n❌ Signal rejected for ${asset}: Trade already in progress`);
    return;
  }

  // 4. Validate balance, reserve stake, etc.
  // ... validation code ...
  // If ANY validation fails, MUST call: tradeManager.releaseTradeLock(asset);

  // 5. Execute trade in try/finally block
  try {
    const result = await tradeExecutionService.executeTrade(signal, asset);
    // ... handle result ...
  } catch (error) {
    // ... handle error ...
  } finally {
    // 6. CRITICAL: ALWAYS release lock after execution
    tradeManager.releaseTradeLock(asset);
  }
}
```

### Why This Pattern is Required

1. **`canOpenTrade()`** - Checks if there's already an open position for this asset
2. **`acquireTradeLock()`** - Prevents race conditions when two signals arrive in milliseconds
3. **`releaseTradeLock()` in finally** - Guarantees lock is released even if trade fails

### Common Mistakes to Avoid

- ❌ DON'T process signals without checking `canOpenTrade()` first
- ❌ DON'T skip the trade lock mechanism
- ❌ DON'T forget to release lock on early returns (validation failures)
- ❌ DON'T put `releaseTradeLock()` only in catch block (use finally)

### Reference Implementations

See these files for correct implementation:

- `packages/trader/src/scripts/run-hybrid-mtf.ts`
- `packages/trader/src/scripts/run-fvg-ls.ts`

---

## Documentation Organization Rules

**CRITICAL: All documentation files (.md) MUST be placed in the appropriate subdirectory of `docs/`, NEVER in the root or package directories.**

### Documentation Structure

```
docs/
├── strategies/          # Strategy documentation (how strategies work, parameters, etc.)
├── guides/              # User guides, tutorials, how-to guides
├── reports/             # Analysis reports, optimization results, findings
│   └── fixes/          # Bug fix reports and summaries
├── deployment/          # Deployment guides and setup instructions
├── architecture/        # Architecture documentation, design decisions, refactoring plans
└── archive/            # Archived/old documentation
```

### Rules for Generating Documentation

1. **Strategy Documentation** → `docs/strategies/`
   - Strategy explanations (e.g., `CRYPTOSCALP_V2_EXECUTIVE_SUMMARY.md`)
   - Strategy READMEs (e.g., `BB_SQUEEZE_README.md`)
   - Strategy lists (e.g., `ESTRATEGIAS_LISTADO.md`)

2. **User Guides** → `docs/guides/`
   - How-to guides (e.g., `BACKTEST_GUIDE.md`, `DASHBOARD_README.md`)
   - Setup guides (e.g., `DEMO_SETUP.md`, `QUICKSTART_WEB_UI.md`)
   - Analysis guides (e.g., `AI_ANALYSIS_GUIDE.md`)

3. **Reports** → `docs/reports/`
   - Analysis reports (e.g., `IMPROVEMENTS_ANALYSIS.md`, `LOSS_ANALYSIS_FINDINGS.md`)
   - Optimization results (e.g., `STRATEGY_OPTIMIZED_WIDER_SL1.md`)
   - Executive summaries (e.g., `RESUMEN_EJECUTIVO_MTF_LEVELS.md`)
   - Session summaries (e.g., `RESUMEN_SESION.md`)
   - Bug fix reports → `docs/reports/fixes/`

4. **Deployment Documentation** → `docs/deployment/`
   - Deployment guides (e.g., `DUAL_STRATEGY_SETUP.md`)
   - PM2 setup (e.g., `KELTNER_MR_PM2_SETUP.md`)

5. **Architecture Documentation** → `docs/architecture/`
   - Architecture docs (e.g., `ARCHITECTURE.md`)
   - Design decisions (e.g., `MULTI_TIMEFRAME_DESIGN.md`)
   - Refactoring plans (e.g., `BACKTEST_REFACTOR_PLAN.md`)

### Files That Stay in Root

- `README.md` - Main project README (standard location)
- `CHANGELOG.md` - Project changelog (standard location)
- `CLAUDE.md` - Claude-specific rules (configuration file)

### Files That Stay in Package Directories

- `packages/*/README.md` - Package-specific READMEs (standard location)
- `packages/*/src/**/README.md` - Component-specific READMEs (standard location)

### When Creating New Documentation

**ALWAYS ask yourself:**
1. Is this a strategy doc? → `docs/strategies/`
2. Is this a guide/tutorial? → `docs/guides/`
3. Is this a report/analysis? → `docs/reports/`
4. Is this about deployment? → `docs/deployment/`
5. Is this about architecture? → `docs/architecture/`

**NEVER create .md files in:**
- Project root (except README.md, CHANGELOG.md, CLAUDE.md)
- Package root directories (except package README.md)
- Source code directories (except component-specific README.md)

### Enforcement

If you see a .md file in the wrong location, immediately move it to the correct `docs/` subdirectory and update any references to it.

